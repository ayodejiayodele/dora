name: Deployment Frequency

on:
  workflow_dispatch:
    inputs: 
      repo:
        description: 'Repository name'
        required: true
        default: 'dora'
      workflowName:
        description: 'Workflow name of yaml filename'
        required: true 
        type: string
      jobname:
        description: 'Job name responsible for production deployment'
        type: string
        required: false
      numberOfDays:
        description: 'Number of days to check for deployment frequency'
        type: integer
        default: 30
        required: false



jobs:
  calculate-frequency:
    runs-on: ubuntu-latest
    steps:
      - name: 'Get Workflows and Jobs'
        uses: actions/github-script@v6
        with:
          script: |

            let productWorkflowRuns = []
            let eligibleWorkflowsRuns = []
            let completionDates = []
            let uniqueDates = []
            let color = 'red'
            let numberOfDays =  ${{ inputs.numberOfDays }}
            let workflowId = "${{ inputs.workflowName }}"
            let jobName = "${{ inputs.jobname }}"

            if (numberOfDays < 30) {
              numberOfDays = 30
            }
            console.log('Number of days')
            console.log(numberOfDays)
            console.log('Workflow ID')
            console.log(workflowId)

            //Remove numberOfDays from the current date
            let earliestDate = new Date()
            earliestDate.setDate(earliestDate.getDate() - numberOfDays)
            let dateToCompare = earliestDate.toISOString()

            console.log('Earliest date')
            console.log(earliestDate.getDate())
            console.log(earliestDate.toISOString())

            const workflowRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
            });

            console.log('Workflow runs count')
            console.log(workflowRuns.data.total_count)

            workflowRuns.data.workflow_runs.forEach((workflowRun) => {
              console.log('Workflow run ID')
              console.log(workflowRun.id)
              console.log('Workflow created at')
              console.log(workflowRun.created_at)

              if (workflowRun.created_at > dateToCompare) {
                console.log('Workflow run is eligible')
                eligibleWorkflowsRuns.push(workflowRun)
                completionDates.push(workflowRun.completed_at.split('T')[0])
              }
            })

            console.log('Eligible workflow runs')
            console.log(eligibleWorkflowsRuns)
            console.log('Completion dates')
            console.log(completionDates)

