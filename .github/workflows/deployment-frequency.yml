name: Deployment Frequency

on:
  workflow_dispatch:
    inputs: 
      repo:
        description: 'Repository name'
        required: true
        default: 'dora'
      workflowName:
        description: 'Workflow name of yaml filename'
        required: true 
        type: string
      jobname:
        description: 'Job name responsible for production deployment'
        type: string
        required: false
      numberOfDays:
        description: 'Number of days to check for deployment frequency'
        type: integer
        default: 30
        required: false



jobs:
  calculate-frequency:
    runs-on: ubuntu-latest
    steps:
      - name: 'Get Workflows and Jobs'
        uses: actions/github-script@v6
        with:
          script: |

            let productWorkflowRuns = []
            let eligibleWorkflowsRuns = []
            let completionDates = []
            let uniqueDates = []
            let color = 'red'
            let numberOfDays =  ${{ inputs.numberOfDays }}
            let workflowId = "${{ inputs.workflowName }}"
            let jobName = "${{ inputs.jobname }}"

            if (numberOfDays < 30) {
              numberOfDays = 30
            }
            console.log('Number of days')
            console.log(numberOfDays)
            console.log('Workflow ID')
            console.log(workflowId)

            //Remove numberOfDays from the current date
            let earliestDate = new Date()
            earliestDate.setDate(earliestDate.getDate() - numberOfDays)
            let dateToCompare = earliestDate.toISOString()

            console.log('Earliest date')
            console.log(earliestDate.getDate())
            console.log(earliestDate.toISOString())

            const workflowRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
            });

            console.log('Workflow runs count')
            console.log(workflowRuns.data.total_count)


            //Get all workflow runs that were completed after the earliest date
            for (const workflowRun of workflowRuns.data.workflow_runs) {
              if (workflowRun.status === 'completed' && workflowRun.updated_at > dateToCompare) {
                eligibleWorkflowsRuns.push(workflowRun)
                completionDates.push(workflowRun.updated_at.split('T')[0])
              }
            }

            console.log('Eligible workflow runs count')
            console.log(eligibleWorkflowsRuns.length)
            console.log('Completion dates count')
            console.log(completionDates.length)

            //if no jobName is provided, add all eligibleWorkflowsRuns to productWorkflowRuns
            if (jobName === '') {
              productWorkflowRuns = eligibleWorkflowsRuns
            } else {
              //Get all workflow runs that have the jobName
              for (const workflowRun of eligibleWorkflowsRuns) {
                const jobs = await github.rest.actions.listJobsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: workflowRun.id,
                });

                for (const job of jobs.data.jobs) {
                  if (job.name === jobName) {
                    productWorkflowRuns.push(workflowRun)
                  }
                }
              }
            }
            
            console.log('Production workflow runs count')
            console.log(productWorkflowRuns.length)

            //uniqueDates = get unique dates from completionDates
            uniqueDates = completionDates.filter((date, index) => {
              return completionDates.indexOf(date) === index
            })

            console.log('Unique dates count')
            console.log(uniqueDates.length)

            let deploymentFrequency = uniqueDates.length / numberOfDays

            console.log('Deployment frequency')
            console.log(deploymentFrequency)

            let deploymentFrequencyPercentage = deploymentFrequency * 100
            let deploymentFrequencyString = ''
            console.log('Deployment frequency percentage')
            console.log(deploymentFrequencyPercentage + '%')
            
            if (deploymentFrequency > 1) {
              deploymentFrequencyString = 'Multiple deployments per day'
              color = 'green'
            } else if (deploymentFrequency == 1) {
              deploymentFrequencyString = 'Daily'
              color = 'green'
            } else {
              deploymentFrequency = 1 / deploymentFrequency
              deploymentFrequency = Math.round(deploymentFrequency * 100)
              deploymentFrequencyString = 'Every' + deploymentFrequency + 'days'
              if (deploymentFrequency < 4) {
                color = 'yellow'
              } else {
                color = 'red'
              }
            }

            let markdown = '## Workflow Name: ' + workflowId + '\n' +
              '- Job Name: ' + jobName + '\n' +
              '- Deployment Frequency: ' + deploymentFrequencyString + '\n' +
              '- Deployment Frequency Percentage: ' + deploymentFrequencyPercentage + '%\n' +
              'You deployed **' + productWorkflowRuns.length + ' workflows** in the last ' + numberOfDays + ' days.\n' +
              'Of these ' + numberOfDays + ' days, you deployed on **' + uniqueDates.length + ' days**.\n' +
              '## Badge Color: ' + color + '\n' +
              '![Deployment Frequency](https://badgen.net/badge/frequency/' + encodeURIComponent(deploymentFrequencyString) + '/' + color + '?icon=github&label=Deployment%20frequency)'

            console.log('Markdown')
            console.log(markdown)

            core.exportVariable('MARKDOWN', markdown)

            const artifact = {
              name: 'deployment-frequency',
              path: 'deployment-frequency.txt',
              contents: uniqueDates.join('\n')
            }

      - name: 'Create job summary'
        run: |
          echo "Hello" >> $GITHUB_SUMMARY

      - name: 'Upload artifact'
        uses: actions/upload-artifact@v2
        with:
          name: deployment-frequency
          path: deployment-frequency.txt